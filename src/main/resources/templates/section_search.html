<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <title>Поиск сообщений</title>

    <style>
        .indent {
            margin: 5px;
        }

        .discussion-name {
            color: grey;
            font-weight: bolder;
        }

        .card-body:hover {
            background-color: rgba(128, 128, 128, 0.235);
        }
    </style>

    <script>
        function onBannedChange(id) {
            let checker = document.getElementById("checker_" + id)
            let checkval = document.getElementById("checkval_" + id)

            checkval.value = checker.checked
        }

        $(document).ready(function () {
            $('#participants_tab_pane').submit(function (e) {
                e.preventDefault();
                var formData = $(this).serialize();

                $.ajax({
                    type: 'POST',
                    url: '/section_participants_ban',
                    data: formData,
                    success: function (response) {
                        alert("Изменения применены!")
                    },
                    error: function (xhr, status, error) {
                        alert('Произошла ошибка:', error);
                    }
                });
            });
            $('#modify_perm_form').submit(function (e) {
                e.preventDefault();
                var formData = $(this).serialize();

                $.ajax({
                    type: 'POST',
                    url: '/section_modify_permissions',
                    data: formData,
                    success: function (response) {
                        alert("Изменения приняты!")
                    },
                    error: function (xhr, status, error) {
                        alert('Произошла ошибка:', error);
                    }
                });
            });
        });

        let perm_rows_id = 0

        function addRole() {
            const button_container = document.getElementById("add_button_container");

            let row = document.createElement('tr');
            const perm_rows_id_local = perm_rows_id;
            row.id = "new_" + perm_rows_id;
            perm_rows_id += 1;

            let data1 = document.createElement('td');
            let inp1 = document.createElement('input');
            inp1.classList.add("form-control");
            inp1.classList.add("form-control-plaintext");
            inp1.name = 'roles';
            data1.append(inp1);

            let data2 = document.createElement('td');
            let inp2 = document.createElement('input');
            inp2.classList.add("form-control");
            inp2.classList.add("form-control-plaintext");
            inp2.name = 'perms';
            data2.append(inp2);

            let data3 = document.createElement('td');
            let button = document.createElement('button');
            button.classList.add("btn");
            button.classList.add("btn-success");
            button.textContent = "V";
            button.type = "button";
            data3.append(button);

            button.onclick = () => {
                button.textContent = "X";
                button.classList.remove("btn-success");
                button.classList.add("btn-danger");
                button.onclick = () => {
                    let row = document.getElementById("new_" + perm_rows_id_local);
                    row.remove();
                };
            };

            row.append(data1);
            row.append(data2);
            row.append(data3);

            button_container.before(row);
        }

    </script>

</head>

<body>
    <div th:insert="~{general :: header(true, null)}"></div>

    <div>
        <div class="border-bottom hstack" style="background-color: aliceblue;">
            <div class="w-50 m-5 vstack gap-4">
                <a class="text-decoration-none" style="color: #2b73df;" href="#" th:href="|section?id=${section.id}| + (${session_id != null} ? |&session=${session_id}| : '')">
                    <h1 th:text="${section.name}" class="text-uppercase opacity-75">
                        Название раздела
                    </h1>
                </a>
                <p th:text="${section.description}">
                    Описание раздела...
                </p>
            </div>

            <div class="w-50"></div>

            <div class="vstack border-start px-3 py-2 w-25">
            </div>
        </div>

    </div>
    
    <div class="container vstack gap-5 p-5">
        <div class="card vstack" th:each="message, iter : ${messages}">
            <div class="hstack border-bottom gap-3 p-2" style="background-color: lightgrey;">
                <a href="#" th:text="${message.discussion.name}" th:id="|result_${iter.index}_discussion_link|"
                   th:href="|/discussion?id=${message.discussion.id}| + (${session_id != null} ? |&session=${session_id}| : '')">Discussion name</a>
            </div>
            
            <div class="m-2 card">
                <div class="hstack border-bottom bg-dark-subtle">
                    <a href="/profile" class="p-2" th:text="${message.creator.nickname}" th:id="|author_${message.id}|"
                        th:href="'/profile?user=' + ${message.creator.id} + (${session_id != null} ? ('&session=' + ${session_id}) : '')">
                        Nickname</a>
                    <div class="vr"></div>
                    <span class="p-2 text-nowrap" th:text="${message.printCreationTime()}">xx:xx:xxxx</span>
                    <div class="vr"></div>
                
                    <div class="hstack position-relative w-100">
                        <div class="vr ms-auto my-0"></div>
                        <a th:href="|/discussion?id=${message.discussion.id}| + (${session_id != null} ? |&session=${session_id}| : '') + |#txt_${message.id}|"
                           th:id="|result_${iter.index}_bord_but|" class="stretched-link" href="#"></a>
                    </div>
                
                    <button class="btn rounded-0 px-5 z-1 position-relative text-nowrap" style="color:green;"
                        th:onclick="|like(${message.id}, '${session_id}')|" th:id="|result_${iter.index}_likes|">
                        <span th:id="|msg_${message.id}_likes|" th:text="${message.likesNum}"></span> <b>+</b>
                    </button>
                    <button class="btn rounded-0 px-5 text-nowrap" style="color: red;" th:id="|result_${iter.index}_dislikes|"
                        th:onclick="|dislike(${message.id}, '${session_id}')|">
                        <span th:id="|msg_${message.id}_dislikes|" th:text="${message.dislikesNum}"></span> <b>-</b>
                    </button>
                </div>
            
                <div class="p-3 position-relative">
                    <a class="p-2 bg-info bg-opacity-25 rounded-3 hstack gap-1 text-decoration-none" th:id="|result_${iter.index}_quote|"
                        th:if="${message.quoted != null}" href="#" th:href="|#txt_${message.quoted.id}|">
                        <span style="min-width: fit-content; font-weight: bold;"
                            th:text="|${message.quoted.creator.nickname}:|">p'Chel:</span>
                        <span class="text-decoration-none overflow-auto" style="max-height: 50px;"
                            th:text="${message.quoted.text}">
                            nickname: quoted message fragment...
                        </span>
                    </a>
                
                    <p th:id="|txt_${message.id}|" class="p-2" style="min-height: fit-content;"
                        th:text="${message.text}">
                        message content...
                    </p>
                </div>
            
                <div class="border-top p-3 bg-light" th:unless="${message.attachments.isEmpty()}">
                    <div class="hstack m-3 gap-2">
                        <a th:each="file, i : ${message.attachments}" th:text="${file.name}" th:id="|result_${iter.index}_attach_${i.index}|"
                            th:href="|/download?file=${file.id}|" th:download="${file.name}">attachments.txt</a>
                    </div>
                </div>
            
            </div>

        </div>

        <h2 style="color: grey; text-align: center;" th:if="${messages.isEmpty()}">Нет результатов</h2>

</body>

</html>
